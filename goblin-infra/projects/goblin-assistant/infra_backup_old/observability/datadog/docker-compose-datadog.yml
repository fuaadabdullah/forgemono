version: '3.8'

services:
  # Datadog Agent for process monitoring
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: datadog-agent
    pid: host  # Required for process monitoring
    restart: unless-stopped

    environment:
      ## REQUIRED: API Key
      - DD_API_KEY=${DD_API_KEY}

      ## Site (US1, EU, etc.)
      - DD_SITE=${DD_SITE:-datadoghq.com}

      ## Hostname
      - DD_HOSTNAME=${DD_HOSTNAME:-goblin-assistant-backend}

      ## Environment
      - DD_ENV=${DD_ENV:-production}

      ## Tags
      - DD_TAGS=env:${DD_ENV:-production} service:goblin-assistant project:forge-monorepo stack:fastapi component:backend

      ## Process Collection
      - DD_PROCESS_AGENT_ENABLED=true
      - DD_PROCESS_CONFIG_RUN_IN_CORE_AGENT=true  # Optimized collection (v7.53.0+)
      - DD_PROCESS_CONFIG_SCRUB_ARGS=true
      - DD_PROCESS_CONFIG_STRIP_PROC_ARGUMENTS=false
      - DD_PROCESS_CONFIG_CUSTOM_SENSITIVE_WORDS=api_key,apikey,token,secret,password,credential,bearer,jwt

      ## System Probe (for I/O stats)
      - DD_SYSTEM_PROBE_ENABLED=true
      - DD_SYSTEM_PROBE_PROCESS_ENABLED=true

      ## Container Collection
      - DD_CONTAINER_COLLECT_ALL=true
      - DD_DOCKER_LABELS_AS_TAGS={"env":"true","service":"true","version":"true"}

      ## APM
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true

      ## DogStatsD
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true

      ## Logs Collection
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true

      ## Integrations
      - DD_AC_EXCLUDE=name:datadog-agent  # Don't monitor self

    volumes:
      # Required for process monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /etc/passwd:/etc/passwd:ro  # For username resolution

      # System probe
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /lib/modules:/lib/modules:ro
      - /usr/src:/usr/src:ro

      # Logs
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /opt/datadog-agent/run:/opt/datadog-agent/run:rw

      # Custom configs (optional)
      - ./datadog-agent.yaml:/etc/datadog-agent/datadog.yaml:ro
      - ./system-probe.yaml:/etc/datadog-agent/system-probe.yaml:ro

    cap_add:
      - SYS_ADMIN  # Required for system-probe
      - SYS_RESOURCE
      - SYS_PTRACE
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
      - IPC_LOCK
      - CHOWN
      - DAC_OVERRIDE

    security_opt:
      - apparmor:unconfined

    networks:
      - backend

    labels:
      com.datadoghq.ad.logs: '[{"source": "datadog-agent", "service": "datadog-agent"}]'

networks:
  backend:
    external: true  # Connect to goblin-assistant backend network
