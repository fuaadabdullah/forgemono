version: 2.1

# Orbs for AWS ECR and Terraform integration
orbs:
  aws-ecr: circleci/aws-ecr@9.0.0
  terraform: circleci/terraform@3.2.1

# Reusable executor definitions
executors:
  python-docker:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/goblin-infra

  terraform-executor:
    docker:
      - image: hashicorp/terraform:1.6
    working_directory: ~/goblin-infra

# Reusable commands
commands:
  setup-terraform:
    description: "Initialize Terraform with HCP Cloud backend"
    parameters:
      environment:
        type: string
    steps:
      - run:
          name: Terraform Init (<< parameters.environment >>)
          command: |
            cd envs/<< parameters.environment >>
            terraform init -input=false
            terraform workspace select GoblinOSAssistant-<< parameters.environment >> || \
            terraform workspace new GoblinOSAssistant-<< parameters.environment >>

  terraform-validate:
    description: "Validate and format check Terraform files"
    parameters:
      environment:
        type: string
    steps:
      - run:
          name: Terraform Format Check
          command: |
            cd envs/<< parameters.environment >>
            terraform fmt -check -recursive || (echo "Run 'terraform fmt -recursive' locally" && exit 1)
      - run:
          name: Terraform Validate
          command: |
            cd envs/<< parameters.environment >>
            terraform validate

# Job definitions
jobs:
  # Backend build and test
  build-and-test-backend:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project
    steps:
      - checkout:
          path: ~/project/ForgeMonorepo
      - run:
          name: Check if backend exists
          command: |
            if [ ! -d "ForgeMonorepo/apps/goblin-assistant/backend" ]; then
              echo "Backend directory not found, skipping tests"
              exit 0
            fi
      - run:
          name: Install backend dependencies
          command: |
            if [ -f "ForgeMonorepo/apps/goblin-assistant/backend/requirements.txt" ]; then
              cd ForgeMonorepo/apps/goblin-assistant/backend
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip install pytest pytest-cov
            fi
      - run:
          name: Run unit tests
          command: |
            if [ -f "ForgeMonorepo/apps/goblin-assistant/backend/requirements.txt" ]; then
              cd ForgeMonorepo/apps/goblin-assistant/backend
              pytest tests/ -v --cov=. --cov-report=xml --cov-report=html || echo "No tests found or tests failed"
            fi
      - store_test_results:
          path: ForgeMonorepo/apps/goblin-assistant/backend/test-results
      - store_artifacts:
          path: ForgeMonorepo/apps/goblin-assistant/backend/htmlcov

  # Docker build and push to GHCR
  build-and-push-backend-image:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    working_directory: ~/project
    steps:
      - checkout:
          path: ~/project/ForgeMonorepo
      - run:
          name: Login to GitHub Container Registry
          command: |
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
      - run:
          name: Build Backend Docker Image
          command: |
            cd ForgeMonorepo/apps/goblin-assistant/backend
            docker build \
              -t ghcr.io/$GHCR_USER/goblin-assistant-backend:${CIRCLE_SHA1} \
              -t ghcr.io/$GHCR_USER/goblin-assistant-backend:latest \
              -f Dockerfile .
      - run:
          name: Push Backend Image
          command: |
            docker push ghcr.io/$GHCR_USER/goblin-assistant-backend:${CIRCLE_SHA1}
            docker push ghcr.io/$GHCR_USER/goblin-assistant-backend:latest
      - run:
          name: Save image info
          command: |
            mkdir -p /tmp/artifacts
            echo "ghcr.io/$GHCR_USER/goblin-assistant-backend:${CIRCLE_SHA1}" > /tmp/artifacts/backend-image.txt
      - persist_to_workspace:
          root: /tmp/artifacts
          paths:
            - backend-image.txt

  # Terraform Plan - Dev
  terraform-plan-dev:
    executor: terraform-executor
    steps:
      - checkout
      - setup-terraform:
          environment: dev
      - terraform-validate:
          environment: dev
      - run:
          name: Terraform Plan (Dev)
          command: |
            cd envs/dev
            terraform plan -input=false -out=tfplan
      - run:
          name: Save plan artifact
          command: |
            mkdir -p /tmp/tfplans
            cp envs/dev/tfplan /tmp/tfplans/dev-tfplan
      - store_artifacts:
          path: /tmp/tfplans
      - persist_to_workspace:
          root: /tmp/tfplans
          paths:
            - dev-tfplan

  # Terraform Apply - Dev (auto on main)
  terraform-apply-dev:
    executor: terraform-executor
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/tfplans
      - setup-terraform:
          environment: dev
      - run:
          name: Terraform Apply (Dev)
          command: |
            cd envs/dev
            cp /tmp/tfplans/dev-tfplan ./tfplan
            terraform apply -input=false tfplan

  # Terraform Plan - Staging
  terraform-plan-staging:
    executor: terraform-executor
    steps:
      - checkout
      - setup-terraform:
          environment: staging
      - terraform-validate:
          environment: staging
      - run:
          name: Terraform Plan (Staging)
          command: |
            cd envs/staging
            terraform plan -input=false -out=tfplan
      - run:
          name: Save plan artifact
          command: |
            mkdir -p /tmp/tfplans
            cp envs/staging/tfplan /tmp/tfplans/staging-tfplan
      - store_artifacts:
          path: /tmp/tfplans
      - persist_to_workspace:
          root: /tmp/tfplans
          paths:
            - staging-tfplan

  # Terraform Apply - Staging (manual)
  terraform-apply-staging:
    executor: terraform-executor
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/tfplans
      - setup-terraform:
          environment: staging
      - run:
          name: Terraform Apply (Staging)
          command: |
            cd envs/staging
            cp /tmp/tfplans/staging-tfplan ./tfplan
            terraform apply -input=false tfplan
      - run:
          name: Run Staging Smoke Tests
          command: |
            if [ -f scripts/staging_smoke_tests.sh ]; then
              bash scripts/staging_smoke_tests.sh
            else
              echo "No staging smoke tests found"
            fi

  # Terraform Plan - Production
  terraform-plan-prod:
    executor: terraform-executor
    steps:
      - checkout
      - setup-terraform:
          environment: prod
      - terraform-validate:
          environment: prod
      - run:
          name: Terraform Plan (Production)
          command: |
            cd envs/prod
            terraform plan -input=false -out=tfplan
      - run:
          name: Save plan artifact
          command: |
            mkdir -p /tmp/tfplans
            cp envs/prod/tfplan /tmp/tfplans/prod-tfplan
      - store_artifacts:
          path: /tmp/tfplans
      - persist_to_workspace:
          root: /tmp/tfplans
          paths:
            - prod-tfplan

  # Terraform Apply - Production (manual with approval)
  terraform-apply-prod:
    executor: terraform-executor
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/tfplans
      - setup-terraform:
          environment: prod
      - run:
          name: Terraform Apply (Production)
          command: |
            cd envs/prod
            cp /tmp/tfplans/prod-tfplan ./tfplan
            terraform apply -input=false tfplan
      - run:
          name: Run Production Smoke Tests
          command: |
            if [ -f scripts/prod_smoke_tests.sh ]; then
              bash scripts/prod_smoke_tests.sh
            else
              echo "No production smoke tests found"
            fi

# Workflow definitions
workflows:
  version: 2

  # CI/CD Pipeline for Development
  dev-pipeline:
    jobs:
      # Build and test
      - build-and-test-backend:
          filters:
            branches:
              only:
                - main
                - develop

      # Build Docker images
      - build-and-push-backend-image:
          requires:
            - build-and-test-backend
          filters:
            branches:
              only:
                - main
                - develop

      # Terraform plan on all PRs
      - terraform-plan-dev:
          requires:
            - build-and-push-backend-image
          filters:
            branches:
              only:
                - main
                - develop

      # Auto-apply to dev on merge to main
      - terraform-apply-dev:
          requires:
            - terraform-plan-dev
          filters:
            branches:
              only: main

  # Staging Pipeline (manual trigger)
  staging-pipeline:
    jobs:
      - build-and-test-backend:
          filters:
            branches:
              only: main

      - build-and-push-backend-image:
          requires:
            - build-and-test-backend
          filters:
            branches:
              only: main

      - terraform-plan-staging:
          requires:
            - build-and-push-backend-image
          filters:
            branches:
              only: main

      - hold-for-staging-approval:
          type: approval
          requires:
            - terraform-plan-staging
          filters:
            branches:
              only: main

      - terraform-apply-staging:
          requires:
            - hold-for-staging-approval
          filters:
            branches:
              only: main

  # Production Pipeline (manual trigger with approvals)
  production-pipeline:
    jobs:
      - build-and-test-backend:
          filters:
            branches:
              only: main
            tags:
              only: /^v.*/

      - build-and-push-backend-image:
          requires:
            - build-and-test-backend
          filters:
            branches:
              only: main
            tags:
              only: /^v.*/

      - terraform-plan-prod:
          requires:
            - build-and-push-backend-image
          filters:
            branches:
              only: main
            tags:
              only: /^v.*/

      - hold-for-prod-approval:
          type: approval
          requires:
            - terraform-plan-prod
          filters:
            branches:
              only: main
            tags:
              only: /^v.*/

      - terraform-apply-prod:
          requires:
            - hold-for-prod-approval
          filters:
            branches:
              only: main
            tags:
              only: /^v.*/
