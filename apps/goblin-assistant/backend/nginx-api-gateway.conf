# Hardened Nginx API Gateway Configuration
# Provides edge-level protection with rate limiting, auth, and request validation
# Place this in /etc/nginx/sites-available/api-gateway
# Then: sudo ln -s /etc/nginx/sites-available/api-gateway /etc/nginx/sites-enabled/
# sudo nginx -t && sudo systemctl reload nginx

# Rate limiting zones (per IP)
limit_req_zone $binary_remote_addr zone=api_general:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=api_chat:10m rate=20r/m;
limit_req_zone $binary_remote_addr zone=api_auth:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=api_health:10m rate=300r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=api_conn:10m;

# Request body size limits
client_max_body_size 1m;
client_body_buffer_size 128k;

# Upstream backend servers
upstream goblin_backend {
    server localhost:8003 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream kong_gateway {
    server localhost:8000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

server {
    listen 443 ssl http2;
    server_name api.goblin.fuaad.ai;

    # SSL configuration
    ssl_certificate /etc/ssl/certs/api.goblin.fuaad.ai.crt;
    ssl_certificate_key /etc/ssl/private/api.goblin.fuaad.ai.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'" always;

    # Connection limits
    limit_conn api_conn 20;

    # CORS preflight handling
    location / {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "https://goblin.fuaad.ai";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key, X-Turnstile-Token";
            add_header Access-Control-Max-Age 86400;
            return 204;
        }
    }

    # Health check endpoint (high rate limit, no auth)
    location /health {
        limit_req zone=api_health burst=100 nodelay;
        access_log off;

        # Health check with backend status
        proxy_pass http://goblin_backend/health;
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;

        # Add gateway health info
        add_header X-Gateway-Status "healthy";
        add_header X-Gateway-Time $date_gmt;
    }

    # Authentication endpoints
    location /auth {
        # Rate limiting for auth
        limit_req zone=api_auth burst=10 nodelay;

        # Request size limits
        client_max_body_size 64k;

        # JWT validation at edge
        auth_jwt "Goblin API";
        auth_jwt_key_file /etc/nginx/jwt_keys.json;

        # Allow unauthenticated auth requests (login/signup)
        location /auth/login {
            auth_jwt off;
        }
        location /auth/signup {
            auth_jwt off;
        }

        # Proxy to Kong (which has additional auth plugins)
        proxy_pass http://kong_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-API-Key $http_x_api_key;

        # Reasonable timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Chat completions (most critical - expensive operations)
    location /chat {
        # Strict rate limiting
        limit_req zone=api_chat burst=5 nodelay;

        # Request size limits
        client_max_body_size 512k;

        # JWT authentication required
        auth_jwt "Goblin API";
        auth_jwt_key_file /etc/nginx/jwt_keys.json;

        # Max tokens validation at edge
        access_by_lua_block {
            local cjson = require "cjson.safe"
            if ngx.req.get_method() == "POST" then
                local body = ngx.req.get_body_data()
                if body then
                    local json = cjson.decode(body)
                    if json and json.max_tokens then
                        if type(json.max_tokens) ~= "number" then
                            ngx.exit(ngx.HTTP_BAD_REQUEST)
                        elseif json.max_tokens > 4096 then
                            ngx.log(ngx.WARN, "Gateway rejecting huge max_tokens: " .. json.max_tokens)
                            ngx.say(cjson.encode({
                                error = "max_tokens too large",
                                message = "Maximum allowed tokens is 4096",
                                requested = json.max_tokens
                            }))
                            ngx.exit(ngx.HTTP_BAD_REQUEST)
                        elseif json.max_tokens < 1 then
                            ngx.exit(ngx.HTTP_BAD_REQUEST)
                        end
                        -- Add validation headers
                        ngx.req.set_header("X-Gateway-Max-Tokens-Validated", json.max_tokens)
                    end
                end
            end
        }

        # Proxy to Kong (with rate limiting and max-tokens validation)
        proxy_pass http://kong_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-API-Key $http_x_api_key;

        # Timeouts for LLM operations
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Streaming support
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # OpenAI-compatible API
    location /v1 {
        # Rate limiting
        limit_req zone=api_chat burst=5 nodelay;

        # Request size limits
        client_max_body_size 512k;

        # JWT authentication required
        auth_jwt "Goblin API";
        auth_jwt_key_file /etc/nginx/jwt_keys.json;

        # Proxy to Kong
        proxy_pass http://kong_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-API-Key $http_x_api_key;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Streaming support
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # General API endpoints
    location /api {
        # General rate limiting
        limit_req zone=api_general burst=20 nodelay;

        # Request size limits
        client_max_body_size 256k;

        # JWT authentication required
        auth_jwt "Goblin API";
        auth_jwt_key_file /etc/nginx/jwt_keys.json;

        # Proxy to Kong
        proxy_pass http://kong_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-API-Key $http_x_api_key;

        # Reasonable timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Block all other requests
    location / {
        deny all;
        return 403;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name api.goblin.fuaad.ai;
    return 301 https://$server_name$request_uri;
}

# Monitoring endpoint (internal only)
server {
    listen 127.0.0.1:8080;
    server_name localhost;

    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }

    location /metrics {
        access_by_lua_block {
            local metrics = {
                active_connections = ngx.var.connections_active,
                reading = ngx.var.connections_reading,
                writing = ngx.var.connections_writing,
                waiting = ngx.var.connections_waiting,
                timestamp = ngx.time()
            }
            ngx.say(require("cjson").encode(metrics))
        }
        access_log off;
    }
}
