name: Documentation CI

on:
  push:
    paths:
      - 'docs/**'
      - '**/*.md'
      - '**/*.txt'
      - '**/*.rst'
      - '**/*.adoc'
      - 'scripts/**'
      - 'templates/**'
      - '.github/workflows/docs-ci.yml'
  pull_request:
    paths:
      - 'docs/**'
      - '**/*.md'
      - '**/*.txt'
      - '**/*.rst'
      - '**/*.adoc'
      - 'scripts/**'
      - 'templates/**'

jobs:
  # ------------------------------------------------------------------------------
  # Structure & Validation
  # ------------------------------------------------------------------------------
  validate-structure:
    name: Validate Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install frontmatter click requests

      - name: Validate docs structure
        run: python scripts/goblin_docs.py scan --path docs

      - name: Validate with doc_cli
        run: python scripts/doc_cli.py validate || echo "doc_cli validation failed"

  # ------------------------------------------------------------------------------
  # Linting & Formatting
  # ------------------------------------------------------------------------------
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node tools
        run: npm install -g markdownlint-cli prettier @mermaid-js/mermaid-cli

      - name: Lint markdown (docs/)
        run: markdownlint "docs/**/*.md" --config .markdownlint.json || true

      - name: Lint markdown (all .md files)
        run: markdownlint "**/*.md" --config .markdownlint.json --ignore-path docs/ || true

      - name: Check formatting
        run: prettier --check "**/*.md" || echo "Formatting issues found"

  # ------------------------------------------------------------------------------
  # Links & Assets
  # ------------------------------------------------------------------------------
  check-links-assets:
    name: Check Links & Assets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install link checker
        run: npm install -g markdown-link-check

      - name: Check links in docs/
        run: markdown-link-check docs/*.md --config .github/workflows/link-check-config.json || true

      - name: Check links in root markdown files
        run: markdown-link-check "*.md" --config .github/workflows/link-check-config.json || true

      - name: Generate diagrams
        run: |
          python scripts/doc_cli.py diagrams || echo "Diagram generation failed or no diagrams found"

  # ------------------------------------------------------------------------------
  # AI Quality Analysis
  # ------------------------------------------------------------------------------
  quality-analysis:
    name: AI Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Check API availability
        id: api-check
        run: |
          echo "Checking if Raptor Mini API is available..."
          if curl -f -s --max-time 10 https://thomasena-auxochromic-joziah.ngrok-free.dev/health > /dev/null; then
            echo "âœ… API is available"
            echo "api_available=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ API is not available. Skipping quality check."
            echo "api_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Run documentation quality check
        if: steps.api-check.outputs.api_available == 'true'
        run: |
          echo "ðŸ” Running documentation quality analysis..."
          python3 doc_quality_check.py --ci --min-score 70 --report quality_report.md

      - name: Create fallback report
        if: steps.api-check.outputs.api_available == 'false'
        run: |
          echo "# Documentation Quality Report" > quality_report.md
          echo "" >> quality_report.md
          echo "âš ï¸ Quality analysis skipped - API unavailable" >> quality_report.md
          echo "" >> quality_report.md
          echo "Manual review recommended." >> quality_report.md

      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-quality-report
          path: quality_report.md

      - name: Comment PR with quality report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'quality_report.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              const lines = report.split('\n');
              const summary = lines.slice(0, 15).join('\n');

              const runUrl = process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID;
              const fullReportLink = lines.length > 15 ? '[View full report](' + runUrl + ')' : '';

              const body = '## ðŸ“Š Documentation Quality Report\n\n' + summary + '\n\n' + fullReportLink;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
